{"version":3,"sources":["utils.js","stargate.js","Map.js","map/clusterSource.js","map/layers.js","App.js","index.js"],"names":["renderRing","props","numOfClusters","totalFunding","colors","offsets","funded_amount","fundingAvg","counts","low","high","total","i","length","push","value","fontSize","r","r0","Math","round","w","html","segment","toFixed","el","document","createElement","innerHTML","firstChild","start","end","color","a0","PI","a1","x0","cos","y0","sin","x1","y1","largeArc","join","buildGeoFeature","doc","lon","lat","fetch","require","methods","request","a","url","method","accessToken","data","res","undefined","headers","Accepts","redirect","body","JSON","stringify","hasJsonStructure","result","parse","type","Object","prototype","toString","call","Boolean","err","Client","baseUrl","this","path","createClient","connection","token","username","password","json","jsonResult","authToken","mapboxgl","process","REACT_APP_MAPBOX_KEY","Map","mapContainerRef","useRef","useState","lng","setLng","setLat","zoom","setZoom","renderMap","features","map","container","current","style","center","addControl","NavigationControl","on","getCenter","getZoom","min","Number","MAX_SAFE_INTEGER","max","properties","threshold","featureCollection","addSource","clusterSource","addLayer","circleLayer","markers","markersOnScreen","updateMarkers","newMarkers","querySourceFeatures","coords","geometry","coordinates","cluster","id","cluster_id","marker","Marker","element","setLngLat","addTo","remove","e","sourceId","isSourceLoaded","slice","placeholder","ReactDOM","render","tags","text","use","substring","width","country_name","town","loan_amount","Array","isArray","buildDialog","abs","lngLat","Popup","setDOMContent","getCanvas","cursor","useEffect","db","REACT_APP_ASTRA_DB_ID","region","REACT_APP_ASTRA_DB_REGION","REACT_APP_STARGATE_USERNAME","REACT_APP_STARGATE_PASSWORD","REACT_APP_TOKEN","namespace","REACT_APP_ASTRA_KEYSPACE","collection","REACT_APP_ASTRA_COLLECTION","baseQuery","whereClause","fetchDocs","ids","sg","promises","get","Promise","all","then","results","feature","response","keys","fetchIds","className","ref","App","StrictMode","getElementById"],"mappings":"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","file":"static/js/main.689e4451.chunk.js","sourcesContent":["import React from 'react';\r\n\r\nfunction shortenNumber(value) {\r\n   if (value >= 10**9)\r\n      return (value / 10**9).toFixed(0) + 'B';\r\n   if (value >= 10**6)\r\n      return (value / 10**6).toFixed(0) + 'M';\r\n   if (value >= 10**3)\r\n      return (value / 10**3).toFixed(0) + 'K';\r\n   return value;\r\n}\r\n\r\nexport function renderRing(props, numOfClusters, totalFunding, colors) {\r\n    var offsets = [];\r\n    var funded_amount = props.funded_amount;\r\n    var fundingAvg = totalFunding / numOfClusters;\r\n    var counts = [\r\n        props.low,\r\n        props.high\r\n    ];\r\n    var total = 0;\r\n    for (var i = 0; i < counts.length; i++) {\r\n        offsets.push(total);\r\n        total += counts[i];\r\n    }\r\n    var fontSize = funded_amount >= fundingAvg * 1.5  ? 22 :\r\n            funded_amount >= fundingAvg        ? 20 :\r\n            funded_amount >= fundingAvg * .5   ? 18 : 16;\r\n    var r = funded_amount >= fundingAvg * 1.5  ? 50 :\r\n            funded_amount >= fundingAvg        ? 32 :\r\n            funded_amount >= fundingAvg * .5   ? 24 : 18;\r\n    var r0 = Math.round(r * 0.6);\r\n    var w = r * 2;\r\n\r\n    var html =\r\n        '<div><svg width=\"' +\r\n        w +\r\n        '\" height=\"' +\r\n        w +\r\n        '\" viewbox=\"0 0 ' +\r\n        w +\r\n        ' ' +\r\n        w +\r\n        '\" text-anchor=\"middle\" style=\"font: ' +\r\n        fontSize +\r\n        'px sans-serif; display: block\">';\r\n\r\n    for (i = 0; i < counts.length; i++) {\r\n        html += segment(\r\n            offsets[i] / total,\r\n            (offsets[i] + counts[i]) / total,\r\n            r,\r\n            r0,\r\n            colors[i]\r\n        );\r\n    }\r\n    html +=\r\n        '<circle cx=\"'+r+'\" cy=\"'+r+'\" r=\"'+r0+'\" fill=\"white\" /><text dominant-baseline=\"central\" transform=\"translate(' +\r\n        r +\r\n        ', ' +\r\n        r +\r\n        ')\">' +\r\n        shortenNumber(props.funded_amount) +\r\n        '</text></svg></div>';\r\n\r\n    var el = document.createElement('div');\r\n    el.innerHTML = html;\r\n    return el.firstChild;\r\n}\r\n\r\nfunction segment(start, end, r, r0, color) {\r\n        if (end - start === 1) end -= 0.00001;\r\n        var a0 = 2 * Math.PI * (start - 0.25);\r\n        var a1 = 2 * Math.PI * (end - 0.25);\r\n        var x0 = Math.cos(a0),\r\n            y0 = Math.sin(a0);\r\n        var x1 = Math.cos(a1),\r\n            y1 = Math.sin(a1);\r\n        var largeArc = end - start > 0.5 ? 1 : 0;\r\n\r\n        return [\r\n            '<path d=\"M',\r\n            r + r0 * x0,\r\n            r + r0 * y0,\r\n            'L',\r\n            r + r * x0,\r\n            r + r * y0,\r\n            'A',\r\n            r,\r\n            r,\r\n            0,\r\n            largeArc,\r\n            1,\r\n            r + r * x1,\r\n            r + r * y1,\r\n            'L',\r\n            r + r0 * x1,\r\n            r + r0 * y1,\r\n            'A',\r\n            r0,\r\n            r0,\r\n            0,\r\n            largeArc,\r\n            0,\r\n            r + r0 * x0,\r\n            r + r0 * y0,\r\n            '\" fill=\"' + color + '\" />'\r\n        ].join(' ');\r\n    }\r\n\r\nexport function buildGeoFeature(doc) {\r\n   return {\r\n      \"type\": \"Feature\", \r\n      \"properties\": doc,\r\n      \"geometry\": { \r\n        \"type\": \"Point\", \r\n        \"coordinates\": [ doc.lon,\r\n                          doc.lat ] \r\n      }\r\n   }\r\n}\r\n\r\nexport function buildDialog(props) {\r\n   const tags = props.tags && JSON.parse(props.tags);\r\n   var text = props.use;\r\n   if (text && text.length > 300)\r\n      text =  text.substring(0, 300) + \"...\";\r\n   return (\r\n      <div style={{width: 200}}>\r\n         <b>{props.country_name}</b>\r\n         <p>Town: {props.town}</p>\r\n         <p>Loan: $ {props.loan_amount.toFixed(2)}</p>\r\n         <p>Funded: $ {props.funded_amount.toFixed(2)}</p>\r\n         <br/>\r\n         <p>{text}</p>\r\n         <br/>\r\n         <p><b>{Array.isArray(tags) && tags.join(\", \")}</b></p>\r\n      </div>\r\n   );\r\n}\r\n","const fetch = require(\"node-fetch\");\r\nconst _ = require(\"lodash\");\r\n\r\nconst methods = {\r\n  get: \"GET\",\r\n  post: \"POST\",\r\n  put: \"PUT\",\r\n  patch: \"PATCH\",\r\n  delete: \"DELETE\",\r\n};\r\n\r\nconst request = async (\r\n  url = \"\",\r\n  method = \"\",\r\n  accessToken = \"\",\r\n  data = null\r\n) => {\r\n\r\n  let res = undefined;\r\n\r\n  if (method === methods.get) {\r\n    res = await fetch(url, {\r\n      method,\r\n      headers: {\r\n        Accepts: \"application/json\",\r\n        \"Content-Type\": \"application/json\",\r\n        \"X-Cassandra-Token\": accessToken,\r\n      },\r\n      redirect: \"follow\",\r\n    });\r\n    return res;\r\n  }\r\n\r\n  if (method === methods.delete) {\r\n    res = await fetch(url, {\r\n      method,\r\n      headers: {\r\n        Accepts: \"application/json\",\r\n        \"Content-Type\": \"application/json\",\r\n        \"X-Cassandra-Token\": accessToken,\r\n      },\r\n      redirect: \"follow\",\r\n      body: data ? JSON.stringify(data) : null\r\n    });\r\n    return res;\r\n  }\r\n\r\n  // All other cases for now will use this approach for fetch.\r\n  res = await fetch(url, {\r\n    method,\r\n    headers: {\r\n      Accepts: \"application/json\",\r\n      \"Content-Type\": \"application/json\",\r\n      \"X-Cassandra-Token\": accessToken,\r\n    },\r\n    redirect: \"follow\",\r\n    body: hasJsonStructure(data) ? data : JSON.stringify(data),\r\n  });\r\n\r\n  return res;\r\n};\r\n\r\n// Performs check as we may already have a json structure.\r\nexport const hasJsonStructure = (data) => {\r\n  if (typeof data !== 'string') return false;\r\n  try {\r\n    const result = JSON.parse(data);\r\n    const type = Object.prototype.toString.call(result);\r\n    const isObjOrArray = Boolean(type === '[object Object]'\r\n      || type === '[object Array]');\r\n    return isObjOrArray;\r\n  } catch (err) {\r\n    return false;\r\n  }\r\n};\r\n\r\nexport default class Client {\r\n  constructor(baseUrl, accessToken) {\r\n    this.baseUrl = baseUrl;\r\n    this.accessToken = accessToken;\r\n  }\r\n\r\n  get(path) {\r\n    return request(this.baseUrl + path, methods.get, this.accessToken);\r\n  }\r\n\r\n  post(path, data) {\r\n    return request(this.baseUrl + path, methods.post, this.accessToken, data);\r\n  }\r\n\r\n  put(path, data) {\r\n    return request(this.baseUrl + path, methods.put, this.accessToken, data);\r\n  }\r\n\r\n  patch(path, data) {\r\n    return request(this.baseUrl + path, methods.patch, this.accessToken, data);\r\n  }\r\n\r\n  delete(path) {\r\n    return request(this.baseUrl + path, methods.delete, this.accessToken);\r\n  }\r\n}\r\n\r\nexport const createClient = async (connection, token) => {\r\n\r\n  // Able to have .env entry with token for reuse.\r\n  // if not specified, generate one!\r\n  if (!token) {\r\n    const res = await request(\r\n      connection.baseUrl + \"/api/rest/v1/auth\",\r\n      methods.post,\r\n      \"\",\r\n      {\r\n        username: connection.username,\r\n        password: connection.password,\r\n      }\r\n    );\r\n    const jsonResult = await res.json();\r\n    const authToken = jsonResult.authToken;\r\n    return new Client(\r\n      connection.baseUrl + \"/api/rest/v2\",\r\n      authToken\r\n    );\r\n  } else {\r\n    return new Client(\r\n      connection.baseUrl + \"/api/rest/v2\", token\r\n    );\r\n  }\r\n};\r\n","import React, { useRef, useEffect, useState } from 'react';\r\nimport ReactDOM from 'react-dom';\r\nimport mapboxgl from 'mapbox-gl';\r\nimport './Map.css';\r\nimport { buildGeoFeature, buildDialog, renderRing } from './utils';\r\nimport { createClient } from './stargate';\r\nimport { circleLayer, textLayer } from './map/layers';\r\nimport { clusterSource } from './map/clusterSource';\r\n\r\nmapboxgl.accessToken = process.env.REACT_APP_MAPBOX_KEY;\r\n\r\nconst Map = () => {\r\n  const mapContainerRef = useRef(null);\r\n\r\n  const [lng, setLng] = useState(5);\r\n  const [lat, setLat] = useState(34);\r\n  const [zoom, setZoom] = useState(1.5);\r\n\r\n\r\n  function renderMap(features) {\r\n\r\n    // https://docs.mapbox.com/mapbox-gl-js/example/cluster-html/\r\n    const map = new mapboxgl.Map({\r\n      container: mapContainerRef.current,\r\n      style: 'mapbox://styles/mapbox/dark-v10',\r\n      center: [lng, lat],\r\n      zoom: zoom\r\n    });\r\n\r\n    // Add navigation control (the +/- zoom buttons)\r\n    map.addControl(new mapboxgl.NavigationControl(), 'top-right');\r\n\r\n    // add move handler to update position panel\r\n    map.on('move', () => {\r\n      setLng(map.getCenter().lng.toFixed(4));\r\n      setLat(map.getCenter().lat.toFixed(4));\r\n      setZoom(map.getZoom().toFixed(2));\r\n    });\r\n\r\n    map.on('load', function () {\r\n\r\n      var min = Number.MAX_SAFE_INTEGER;\r\n      var max = 0;\r\n      var totalFunding = 0;\r\n      for (var i = 0; i < features.length; i++) {\r\n        const funded_amount = features[i].properties.funded_amount;\r\n        totalFunding += funded_amount;\r\n        if (funded_amount < min)\r\n          min = funded_amount\r\n        if (funded_amount > max)\r\n          max = funded_amount \r\n        }   \r\n      var threshold = ((max - min) / 2)\r\n      const featureCollection = {\r\n        \"type\": \"FeatureCollection\",\r\n        \"features\": features\r\n      }\r\n\r\n    var low = ['<', ['get', 'funded_amount'], threshold];\r\n    var high = ['>=', ['get', 'funded_amount'], threshold];\r\n\r\n    // Add a geojson point source.\r\n    map.addSource('kiva-loans', clusterSource(featureCollection, low, high));\r\n\r\n    // colors to use for the categories\r\n    var colors = ['#f26375', '#acf0a5'];\r\n    \r\n      \r\n    // circle and symbol layers for rendering individual loans (unclustered points)\r\n    map.addLayer(circleLayer(low, high, colors));\r\n    map.addLayer(textLayer());\r\n      \r\n\r\n      // objects for caching and keeping track of HTML marker objects (for performance)\r\n      var markers = {};\r\n      var markersOnScreen = {};\r\n\r\n      function updateMarkers() {\r\n          var newMarkers = {};\r\n          var features = map.querySourceFeatures('kiva-loans');\r\n\r\n          // for every cluster on the screen, create an HTML marker for it (if we didn't yet),\r\n          // and add it to the map if it's not there already\r\n          for (var i = 0; i < features.length; i++) {\r\n              var coords = features[i].geometry.coordinates;\r\n              var props = features[i].properties;\r\n              if (!props.cluster) continue;\r\n              var id = props.cluster_id;\r\n\r\n              var marker = markers[id];\r\n              if (!marker) {\r\n                  var el = renderRing(props, features.length, totalFunding, colors);\r\n                  marker = markers[id] = new mapboxgl.Marker({\r\n                      element: el\r\n                  }).setLngLat(coords);\r\n              }\r\n              newMarkers[id] = marker;\r\n\r\n              if (!markersOnScreen[id]) marker.addTo(map);\r\n          }\r\n          // for every marker we've added previously, remove those that are no longer visible\r\n          for (id in markersOnScreen) {\r\n              if (!newMarkers[id]) markersOnScreen[id].remove();\r\n          }\r\n          markersOnScreen = newMarkers;\r\n      }\r\n\r\n      // after the GeoJSON data is loaded, update markers on the screen and do so on every map move/moveend\r\n      map.on('data', function (e) {\r\n          if (e.sourceId !== 'kiva-loans' || !e.isSourceLoaded) return;\r\n          map.on('move', updateMarkers);\r\n          map.on('moveend', updateMarkers);\r\n          updateMarkers();\r\n      });\r\n\r\n      map.on('click', 'loan_dots', function (e) {\r\n        var coordinates = e.features[0].geometry.coordinates.slice();\r\n        \r\n        const placeholder = document.createElement('div');\r\n        ReactDOM.render(buildDialog(e.features[0].properties), placeholder);\r\n         \r\n        // Ensure that if the map is zoomed out such that multiple\r\n        // copies of the feature are visible, the popup appears\r\n        // over the copy being pointed to.\r\n        while (Math.abs(e.lngLat.lng - coordinates[0]) > 180) {\r\n          coordinates[0] += e.lngLat.lng > coordinates[0] ? 360 : -360;\r\n        }\r\n         \r\n        new mapboxgl.Popup()\r\n          .setLngLat(coordinates)\r\n          .setDOMContent(placeholder)\r\n          .addTo(map);\r\n      });\r\n         \r\n      // Change the cursor to a pointer when the mouse is over the places layer.\r\n      map.on('mouseenter', 'loan_dots', function () {\r\n        map.getCanvas().style.cursor = 'pointer';\r\n      });\r\n         \r\n      // Change it back to a pointer when it leaves.\r\n      map.on('mouseleave', 'loan_dots', function () {\r\n        map.getCanvas().style.cursor = '';\r\n      });\r\n        \r\n    });\r\n  }\r\n\r\n  // Initialize map when component mounts\r\n  useEffect(() => {\r\n\r\n    \r\n    const db = process.env.REACT_APP_ASTRA_DB_ID,\r\n      region = process.env.REACT_APP_ASTRA_DB_REGION,\r\n      username = process.env.REACT_APP_STARGATE_USERNAME,\r\n      password = process.env.REACT_APP_STARGATE_PASSWORD,\r\n      token = process.env.REACT_APP_TOKEN,\r\n      namespace = process.env.REACT_APP_ASTRA_KEYSPACE,\r\n      collection = process.env.REACT_APP_ASTRA_COLLECTION,\r\n      baseQuery = `/namespaces/${namespace}/collections/${collection}/`,\r\n      whereClause = '?where={\"posted_time\": { \"$gte\": \"2000-01-01\" } }';\r\n\r\n    async function fetchDocs(ids) {\r\n      const sg = await createClient({\r\n        baseUrl: `https://${db}-${region}.apps.astra.datastax.com`,\r\n        username,\r\n        password,\r\n      }, token);\r\n\r\n      var promises = [];\r\n      for (var i = 0; i < ids.length; i++) {\r\n        promises.push(sg.get(baseQuery + ids[i]));\r\n      }\r\n\r\n      Promise.all(promises).then(async results => {\r\n        var features = [];\r\n        for (var i = 0; i < ids.length; i++) {\r\n          const body = await results[i].json();\r\n          const feature = buildGeoFeature(body.data);\r\n          features.push(feature);\r\n        }\r\n        renderMap(features);\r\n      });\r\n    }\r\n\r\n    async function fetchIds() {\r\n      const sg = await createClient({\r\n        baseUrl: `https://${db}-${region}.apps.astra.datastax.com`,\r\n        username,\r\n        password,\r\n      }, token);\r\n      const response = await sg.get(baseQuery + whereClause);\r\n      const body = await response.json();\r\n      const ids = Object.keys(body.data);\r\n      fetchDocs(ids);\r\n    }\r\n    fetchIds();\r\n  }, []); // eslint-disable-line react-hooks/exhaustive-deps\r\n\r\n  return (\r\n    <div>\r\n      <div className='sidebarStyle'>\r\n        <div>\r\n          <p><b>STARGATE  &#94; Colonel Jack</b></p>  \r\n          Longitude: {lng} | Latitude: {lat} | Zoom: {zoom}\r\n        </div>\r\n      </div>\r\n      <div className='map-container' ref={mapContainerRef} />\r\n    </div>\r\n  );\r\n};\r\n\r\nexport default Map;","export function clusterSource(featureCollection, low, high) {\r\n  return {\r\n    'type': 'geojson',\r\n    'data': featureCollection,\r\n    'cluster': true,\r\n    'clusterRadius': 80,\r\n    'clusterProperties': {\r\n        // keep separate counts for each magnitude category in a cluster\r\n        'low': ['+', ['case', low, 1, 0]],\r\n        'high': ['+', ['case', high, 1, 0]],\r\n        'funded_amount': ['+', ['get', 'funded_amount']]\r\n    }\r\n  }\r\n}","export function textLayer() {\r\n  return {\r\n    'id': 'loan_dots',\r\n    'type': 'symbol',\r\n    'source': 'kiva-loans',\r\n    'filter': ['!=', 'cluster', true],\r\n    'layout': {\r\n        'text-field': [\r\n            'number-format',\r\n            ['get', 'funded_amount'],\r\n            { 'min-fraction-digits': 1, 'max-fraction-digits': 1 }\r\n        ],\r\n        'text-font': ['Open Sans Semibold', 'Arial Unicode MS Bold'],\r\n        'text-size': 10\r\n    },\r\n    'paint': {\r\n        'text-color': 'white'\r\n    }\r\n  }\r\n};\r\n\r\nexport function circleLayer(low, high, colors) {\r\n  return {\r\n    'id': 'loan_clusters',\r\n    'type': 'circle',\r\n    'source': 'kiva-loans',\r\n    'filter': ['!=', 'cluster', true],\r\n    'paint': {\r\n        'circle-color': [\r\n            'case',\r\n            low,\r\n            colors[0],\r\n            high,\r\n            colors[1],\r\n            colors[1]\r\n        ],\r\n        'circle-opacity': 0.6,\r\n        'circle-radius': 12\r\n    }\r\n  }\r\n};","import React from 'react';\r\nimport Map from './Map';\r\n\r\nfunction App() {\r\n  return (\r\n    <div>\r\n      <Map />\r\n    </div>\r\n  );\r\n}\r\n\r\nexport default App;","import React from 'react';\r\nimport ReactDOM from 'react-dom';\r\nimport './index.css';\r\nimport App from './App';\r\n\r\nReactDOM.render(\r\n  <React.StrictMode>\r\n    <App />\r\n  </React.StrictMode>,\r\n  document.getElementById('root')\r\n);"],"sourceRoot":""}